<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMask NFT检测器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            background-color: #f6851b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 20px 0;
        }
        button:hover {
            background-color: #e2761b;
        }
        #status, #nftList {
            margin: 20px 0;
        }
        .nft-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .nft-item h3 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>MetaMask NFT检测器</h1>
    <p>这个简单的应用将连接到你的MetaMask钱包并显示你拥有的NFT收藏品。</p>
    
    <button id="connectBtn">连接MetaMask</button>
    
    <div id="status">请点击上方按钮连接到MetaMask</div>
    
    <div id="accountInfo"></div>
    
    <h2>你的NFT收藏品</h2>
    <div id="nftList"></div>

    <script>
        const connectBtn = document.getElementById('connectBtn');
        const statusDiv = document.getElementById('status');
        const accountInfoDiv = document.getElementById('accountInfo');
        const nftListDiv = document.getElementById('nftList');
        
        // ERC-721 接口 ABI (简化版)
        const ERC721_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function name() view returns (string)",
            "function symbol() view returns (string)"
        ];
        
        // 连接MetaMask
        async function connectWallet() {
            try {
                statusDiv.textContent = "正在连接到MetaMask...";
                console.log("检测到window.ethereum:", window.ethereum ? "是" : "否");
                console.log("window.ethereum类型:", typeof window.ethereum);
                
                // 检查MetaMask是否已安装
                if (typeof window.ethereum === 'undefined') {
                    statusDiv.textContent = "错误: 请安装MetaMask插件!";
                    return;
                }
                
                // 检查是否真的是MetaMask
                const isMetaMask = window.ethereum.isMetaMask;
                if (!isMetaMask) {
                    statusDiv.textContent = "错误: 检测到以太坊提供者，但不是MetaMask!";
                    return;
                }
                
                // 请求账户访问权限
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const account = accounts[0];
                
                statusDiv.textContent = "已连接到MetaMask!";
                accountInfoDiv.innerHTML = `<p><strong>已连接的钱包地址:</strong> ${account}</p>`;
                
                // 获取NFT
                await fetchNFTs(account);
                
                // 监听账户变化
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        const newAccount = accounts[0];
                        accountInfoDiv.innerHTML = `<p><strong>已连接的钱包地址:</strong> ${newAccount}</p>`;
                        fetchNFTs(newAccount);
                    } else {
                        statusDiv.textContent = "已断开与MetaMask的连接";
                        accountInfoDiv.innerHTML = '';
                        nftListDiv.innerHTML = '';
                    }
                });
                
            } catch (error) {
                console.error(error);
                statusDiv.textContent = `错误: ${error.message}`;
            }
        }
        
        // 获取NFT收藏品
        async function fetchNFTs(address) {
            try {
                statusDiv.textContent = "正在获取NFT收藏品...";
                nftListDiv.innerHTML = '';
                
                // 这里我们使用连接的网络
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // 获取网络信息
                const network = await provider.getNetwork();
                const chainId = network.chainId;
                console.log("当前连接到的链ID:", chainId);
                
                // 使用提供的特定NFT合约地址
                const nftContracts = [
                    "0xba7995B05B0a7764BB744ab1D09c1850014B7032", // 你的第一个NFT合约
                    "0x86F77bCb16588753549C34d34748d2E7Ad82Ea8b"  // 你的第二个NFT合约
                ];
                
                let foundNFTs = false;
                
                for (const contractAddress of nftContracts) {
                    try {
                        const contract = new ethers.Contract(contractAddress, ERC721_ABI, provider);
                        
                        // 获取用户在此合约中拥有的NFT数量
                        const balance = await contract.balanceOf(address);
                        const balanceNum = parseInt(balance.toString());
                        
                        if (balanceNum > 0) {
                            foundNFTs = true;
                            
                            // 获取合约名称和符号（捕获可能的错误）
                            let name, symbol;
                            try {
                                name = await contract.name();
                            } catch (e) {
                                console.log("无法获取合约名称:", e);
                                name = "未知名称";
                            }
                            
                            try {
                                symbol = await contract.symbol();
                            } catch (e) {
                                console.log("无法获取合约符号:", e);
                                symbol = "未知符号";
                            }
                            
                            for (let i = 0; i < balanceNum; i++) {
                                try {
                                    // 获取用户拥有的tokenId
                                    const tokenId = await contract.tokenOfOwnerByIndex(address, i);
                                    
                                    // 获取token URI (元数据)
                                    let tokenURI;
                                    try {
                                        tokenURI = await contract.tokenURI(tokenId);
                                    } catch (e) {
                                        tokenURI = "无法获取";
                                    }
                                    
                                    // 创建NFT信息显示
                                    const nftElement = document.createElement('div');
                                    nftElement.className = 'nft-item';
                                    nftElement.innerHTML = `
                                        <h3>${name} #${tokenId}</h3>
                                        <p><strong>合约地址:</strong> ${contractAddress}</p>
                                        <p><strong>代币ID:</strong> ${tokenId}</p>
                                        <p><strong>代币符号:</strong> ${symbol}</p>
                                        <p><strong>元数据URI:</strong> ${tokenURI}</p>
                                    `;
                                    
                                    nftListDiv.appendChild(nftElement);
                                } catch (e) {
                                    console.error(`获取token ${i}失败:`, e);
                                }
                            }
                        }
                    } catch (e) {
                        console.error(`检查合约 ${contractAddress} 失败:`, e);
                    }
                }
                
                // 还可以尝试使用外部API检索NFT
                // 例如OpenSea API或Moralis API
                
                if (!foundNFTs) {
                    // 如果在指定的合约列表中没有找到NFT,可以尝试提供更多信息
                    nftListDiv.innerHTML = `
                        <p>在检查的合约中没有找到NFT。</p>
                        <p>可能的原因:</p>
                        <ul>
                            <li>你的NFT合约地址不在我们的检查列表中</li>
                            <li>你的NFT可能在不同的网络上(例如Polygon、Arbitrum等)</li>
                        </ul>
                        <p>要检测特定NFT,请修改代码中的nftContracts数组,添加你的NFT合约地址。</p>
                    `;
                }
                
                statusDiv.textContent = "NFT检测完成!";
                
            } catch (error) {
                console.error(error);
                statusDiv.textContent = `获取NFT时出错: ${error.message}`;
            }
        }
        
        connectBtn.addEventListener('click', connectWallet);
    </script>
</body>
</html>
